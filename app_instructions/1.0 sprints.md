

# ðŸš€ Mobistay Backend: Post-Auth Execution Roadmap

**Project Phase:** 1.5 - Provider Onboarding & Core Domain Logic  
**Architecture:** Modular Monolith (Next.js 15 + Prisma + Edge Middleware)  
**Security Standard:** `mobistay_token` (HTTP-Only Cookie) + RBAC (Role Based Access Control)

---

## Sprint 1: The Extended Profile & KYC Engine
**Objective:** Capture identity documents and personal details required for safety.

### 1.1 User Profile Update
*   **Endpoint:** `PATCH /api/users/profile`
*   **Fields:** 
    *   `firstName`: String (Optional update)
    *   `lastName`: String (Optional update)
    *   `bio`: String (Max 240 chars)
    *   `avatarUrl`: String (UploadThing URL)
    *   `address`: String
*   **Logic:** Uses Zod to validate `avatarUrl` is a valid `https` link.

### 1.2 Document Submission (The Verification Trigger)
*   **Endpoint:** `POST /api/users/verify/documents`
*   **Fields:**
    *   `idCardUrl`: String (Front of National ID)
    *   `ownershipDocUrl`: String (For Owners: Title deed/Utility bill)
    *   `licenseImageUrl`: String (For Drivers: Driver's License)
*   **Logic:** 
    1.  Save to `OwnerProfile` or `DriverProfile` tables.
    2.  Set `User.idStatus = "PENDING"`.
    3.  Emit a **Pusher** event to the Admin Dashboard for "New Verification Pending."

---

## Sprint 2: Owner Module (Stay Listing CRUD)
**Objective:** Enable verified Owners to populate the platform with Guest Houses.

### 2.1 Property Creation
*   **Endpoint:** `POST /api/properties`
*   **Auth Guard:** `role === "OWNER"` AND `idStatus === "APPROVED"`
*   **Fields:**
    *   `title`: String (e.g., "Luxury 2-Bedroom Apartment - Bastos")
    *   `description`: Text
    *   `address`: String
    *   `city`: Enum (DOUALA, YAOUNDE, BAMENDA, BUEA, LIMBE)
    *   `pricePerNight`: Float
    *   `amenities`: String[] (e.g., ["WIFI", "AC", "PARKING", "GENERATOR"])
    *   `images`: String[] (Min 3, Max 10 UploadThing URLs)
*   **Backend Logic:** Use **Sharp** for metadata extraction to ensure images are not too large before final database entry.

### 2.2 Availability Management
*   **Endpoint:** `PATCH /api/properties/:id/availability`
*   **Fields:**
    *   `blockedDates`: Date[] (Manual dates the owner wants to close)
    *   `isActive`: Boolean (Toggle listing visibility)

---

## Sprint 3: Driver Module (Move Assets & Presence)
**Objective:** Finalize driver setup and enable real-time status.

### 3.1 Vehicle Registration
*   **Endpoint:** `POST /api/driver/vehicle`
*   **Auth Guard:** `role === "DRIVER"`
*   **Fields:**
    *   `vehicleModel`: String (e.g., "Toyota Avensis")
    *   `vehiclePlate`: String (Unique, e.g., "LT 445 HB")
    *   `vehicleColor`: String
    *   `vehicleType`: Enum (STANDARD, COMFORT, LARGE_GROUP)
    *   `licenseNumber`: String (Unique)

### 3.2 Live Status (The "Go Online" Switch)
*   **Endpoint:** `PATCH /api/driver/status`
*   **Fields:** `isOnline: Boolean`
*   **Logic:**
    1.  Update `isOnline` in Postgres.
    2.  Store Driver's last known Location in **Upstash Redis** (Geospatial index).
    3.  TTL in Redis: 5 minutes (to prevent ghost drivers if they lose connection).

---

## Sprint 4: Admin Moderation & Oversight
**Objective:** The central control for platform quality.

### 4.1 Global Verification Handler
*   **Endpoint:** `PATCH /api/admin/users/:id/verify`
*   **Auth Guard:** `role === "ADMIN"`
*   **Fields:**
    *   `status`: Enum (APPROVED, REJECTED)
    *   `reason`: String (If rejected)
*   **Logic:** 
    1.  Update `idStatus` in Postgres.
    2.  If `APPROVED`, update `isVerified = true`.
    3.  Trigger **Resend Email** or **Africa's Talking SMS** to notify the user.

---

## Sprint 5: Discovery & Search (The Traveler Experience)
**Objective:** Allow Travelers to find and filter services.

### 5.1 The Unified Search API
*   **Endpoint:** `GET /api/search`
*   **Query Params:** `?type=stay|move&city=douala&priceMin=10000&priceMax=50000`
*   **Logic:** 
    *   **Stays:** Return properties where `isActive: true` and `isVerified: true`.
    *   **Move:** Return nearby drivers (using Redis `GEORADIUS` command).

---

## ðŸ›  Engineering Quality Standards for these Sprints

### 1. Image Processing (The "Africa-Speed" Rule)
Any image URL submitted to the backend must be processed.
*   **Tool:** `sharp`
*   **Standard:** Convert all uploads to `.webp` at 80% quality. This reduces data usage for users in low-bandwidth areas by up to 60%.

### 2. Response Formatting
Every endpoint must return a consistent JSON structure:
```json
{
  "success": true,
  "data": { ... },
  "message": "Action completed successfully"
}
```

### 3. Error Handling (The "Security" Rule)
Never return raw database errors.
*   **Wrong:** `Table User does not have column xyz`
*   **Right:** `Invalid request parameters. Please check your input.`

### 4. Database Indexing (Neon Postgres)
As a backend engineer, you must add these indexes in Sprint 2 & 3:
*   `CREATE INDEX idx_property_city ON "Property"("city");`
*   `CREATE INDEX idx_user_role ON "User"("role");`

---

## ðŸ§ª Testing the Sprints

### Automated Tests (Vitest)
*   **RBAC Test:** Ensure a user with `role: TRAVELER` receives a `403` when hitting `/api/properties`.
*   **Validation Test:** Ensure a property cannot be created with a negative `pricePerNight`.

### Manual Postman Verification
1.  **Login** to get the `mobistay_token`.
2.  **Submit Driver Docs** via `/api/users/verify/documents`.
3.  **Check Admin Panel** to see the pending request.
4.  **Approve** and verify the `idStatus` changes to `APPROVED`.
5.  **List Property** and verify it appears in the `GET /api/search` results.

---

**Next Immediate Task for Devs:** Initialize the `DriverProfile` and `OwnerProfile` services in the `src/services` folder to handle Sprint 1.