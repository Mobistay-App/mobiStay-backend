// 1. Setup
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// 2. Enums (Type Safety for Roles and Statuses)
enum UserRole {
  TRAVELER
  OWNER
  DRIVER
  ADMIN
}

enum VerificationStatus {
  UNVERIFIED
  PENDING
  APPROVED
  REJECTED
}

enum BookingStatus {
  PENDING
  CONFIRMED
  COMPLETED
  CANCELLED
}

enum RideStatus {
  REQUESTED
  ACCEPTED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

// 3. User & Auth Module
model User {
  id            String    @id @default(cuid())
  email         String?   @unique
  phone         String?   @unique
  password      String    // Hashed password
  role          UserRole  @default(TRAVELER)
  
  // Profile Information
  firstName     String?
  lastName      String?
  avatarUrl     String?
  bio           String?   @db.VarChar(240)
  address       String?
  
  // Verification State
  isVerified    Boolean            @default(false)
  idStatus      VerificationStatus @default(UNVERIFIED)
  
  // Relations
  ownerProfile  OwnerProfile?      // One-to-one
  driverProfile DriverProfile?     // One-to-one
  properties    Property[]         // Properties owned
  bookings      Booking[]          // Stays booked as a traveler
  ridesRequested Ride[]            @relation("PassengerRides")
  verificationLogs VerificationLog[] // Audit trail
  
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
}

// 4. Identity & Verification Module
model OwnerProfile {
  id                String             @id @default(cuid())
  userId            String             @unique
  user              User               @relation(fields: [userId], references: [id])
  businessLicense   String?            // URL to document
  idCardUrl         String?            // URL to document
  verificationNote  String?            // Admin feedback
}

model DriverProfile {
  id                String             @id @default(cuid())
  userId            String             @unique
  user              User               @relation(fields: [userId], references: [id])
  licenseNumber     String             @unique
  vehicleModel      String
  vehiclePlate      String             @unique
  licenseImageUrl   String?
  isOnline          Boolean            @default(false)
  rides             Ride[]             @relation("DriverRides")
}

// 5. Stay Module (Guest Houses)
model Property {
  id            String    @id @default(cuid())
  ownerId       String
  owner         User      @relation(fields: [ownerId], references: [id])
  title         String
  description   String
  address       String
  city          String
  pricePerNight Float
  images        String[]  // Array of URLs from UploadThing
  amenities     String[]
  isActive      Boolean   @default(true)
  blockedDates  DateTime[]
  bookings      Booking[]
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

model Booking {
  id            String        @id @default(cuid())
  propertyId    String
  property      Property      @relation(fields: [propertyId], references: [id])
  travelerId    String
  traveler      User          @relation(fields: [travelerId], references: [id])
  checkIn       DateTime
  checkOut      DateTime
  totalPrice    Float
  status        BookingStatus @default(PENDING)
  paymentId     String?       @unique
}

// 6. Move Module (Ride Sharing)
model Ride {
  id            String      @id @default(cuid())
  passengerId   String
  passenger     User        @relation("PassengerRides", fields: [passengerId], references: [id])
  driverId      String?
  driver        DriverProfile? @relation("DriverRides", fields: [driverId], references: [id])
  pickupLocation String
  dropoffLocation String
  fare          Float
  status        RideStatus  @default(REQUESTED)
  
  createdAt     DateTime    @default(now())
}

// 7. Security & Temp Tokens
model VerificationToken {
  id         String   @id @default(cuid())
  identifier String   // email or phone
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// 8. Audit & Logging
model VerificationLog {
  id          String             @id @default(cuid())
  userId      String
  user        User               @relation(fields: [userId], references: [id])
  adminId     String?            // Null if system/auto updated, otherwise ID of Admin
  previousStatus VerificationStatus
  newStatus   VerificationStatus
  reason      String?            // Why was it rejected/approved?
  
  createdAt   DateTime           @default(now())
}